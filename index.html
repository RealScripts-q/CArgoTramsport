<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>3D Cargo Delivery Game</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { display: block; }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      background: rgba(0,0,0,0.5);
      padding: 10px;
      font-family: sans-serif;
    }
  </style>
</head>
<body>
  <div id="ui">
    <p>Scraps: <span id="scraps">0</span></p>
    <button onclick="upgrade()">Upgrade Cargo Space (Cost: 10)</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/cannon-es@0.20.0/dist/cannon-es.js"></script>
  <script>
    let scraps = 0;
    let cargoLevel = 1;

    // Scene setup
    const scene = new THREE.Scene();
    scene.background = new THREE.Color(0x87ceeb); // sky blue

    const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 5, 10);

    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lighting
    const light = new THREE.DirectionalLight(0xffffff, 1);
    light.position.set(5, 10, 7.5);
    scene.add(light);

    // Physics world
    const world = new CANNON.World({
      gravity: new CANNON.Vec3(0, -9.82, 0)
    });

    // Ground
    const groundBody = new CANNON.Body({
      shape: new CANNON.Plane(),
      mass: 0
    });
    groundBody.quaternion.setFromEuler(-Math.PI / 2, 0, 0);
    world.addBody(groundBody);

    const ground = new THREE.Mesh(
      new THREE.PlaneGeometry(1000, 1000),
      new THREE.MeshStandardMaterial({ color: 0x228B22 }) // green
    );
    ground.rotation.x = -Math.PI / 2;
    scene.add(ground);

    // Car
    const chassisShape = new CANNON.Box(new CANNON.Vec3(1, 0.5, 0.5));
    const chassisBody = new CANNON.Body({ mass: 150 });
    chassisBody.addShape(chassisShape);
    chassisBody.position.set(0, 2, 0);
    world.addBody(chassisBody);

    const chassisMesh = new THREE.Mesh(
      new THREE.BoxGeometry(2, 1, 1),
      new THREE.MeshStandardMaterial({ color: 0xff0000 })
    );
    scene.add(chassisMesh);

    // Wheels (no joints for simplicity)
    function createWheel(offsetX) {
      const wheelShape = new CANNON.Sphere(0.4);
      const wheelBody = new CANNON.Body({ mass: 30 });
      wheelBody.addShape(wheelShape);
      wheelBody.position.set(offsetX, 1, 0.6);
      world.addBody(wheelBody);

      const wheelMesh = new THREE.Mesh(
        new THREE.SphereGeometry(0.4),
        new THREE.MeshStandardMaterial({ color: 0x000000 })
      );
      scene.add(wheelMesh);

      return { body: wheelBody, mesh: wheelMesh };
    }

    const frontWheel = createWheel(1);
    const rearWheel = createWheel(-1);

    // Keyboard controls
    const keys = {};
    document.addEventListener('keydown', e => keys[e.key] = true);
    document.addEventListener('keyup', e => keys[e.key] = false);

    function handleInput() {
      if (keys['d']) chassisBody.velocity.x += 0.1;
      if (keys['a']) chassisBody.velocity.x -= 0.1;
    }

    // Reward logic
    function checkDelivery() {
      if (chassisBody.position.x > 50) {
        scraps += 5 * cargoLevel;
        document.getElementById('scraps').textContent = scraps;
        chassisBody.position.x = 0;
        chassisBody.velocity.set(0, 0, 0);
      }
    }

    // Upgrade
    function upgrade() {
      if (scraps >= 10) {
        scraps -= 10;
        cargoLevel++;
        document.getElementById('scraps').textContent = scraps;

        // Add cargo block visually
        const block = new THREE.Mesh(
          new THREE.BoxGeometry(0.5, 0.5, 0.5),
          new THREE.MeshStandardMaterial({ color: 0xffff00 })
        );
        block.position.set(0, 1.5, 0);
        scene.add(block);
      }
    }

    // Animate
    function animate() {
      requestAnimationFrame(animate);

      handleInput();
      world.fixedStep();
      checkDelivery();

      // Sync positions
      chassisMesh.position.copy(chassisBody.position);
      chassisMesh.quaternion.copy(chassisBody.quaternion);

      frontWheel.mesh.position.copy(frontWheel.body.position);
      rearWheel.mesh.position.copy(rearWheel.body.position);

      camera.position.x = chassisBody.position.x + 5;
      camera.lookAt(chassisBody.position);

      renderer.render(scene, camera);
    }

    animate();
  </script>
</body>
</html>
